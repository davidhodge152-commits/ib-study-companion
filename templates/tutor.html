{% extends "base.html" %}
{% block title %}AI Tutor â€” IB Study Companion{% endblock %}

{% block head %}
<!-- Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- KaTeX for LaTeX math -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<!-- DOMPurify for XSS prevention -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<style>
.tutor-msg pre { background: #f1f5f9; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
.dark .tutor-msg pre { background: #1e293b; }
.tutor-msg code { font-size: 0.85em; }
.tutor-msg pre code { background: none; padding: 0; }
.tutor-msg code:not(pre code) { background: #e2e8f0; padding: 0.1em 0.3em; border-radius: 0.25rem; }
.dark .tutor-msg code:not(pre code) { background: #334155; }
.tutor-msg ul, .tutor-msg ol { padding-left: 1.5rem; margin: 0.5rem 0; }
.tutor-msg li { margin: 0.25rem 0; }
.tutor-msg p { margin: 0.25rem 0; }
.tutor-msg .katex { font-size: 1em; }
.tutor-msg .katex-display { margin: 0.5em 0; overflow-x: auto; }
.typing-indicator span { animation: blink 1.4s infinite both; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
.follow-up-chip { cursor: pointer; transition: all 0.15s; }
.follow-up-chip:hover { background-color: #e0e7ff; }
.dark .follow-up-chip:hover { background-color: #312e81; }
</style>
{% endblock head %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-8rem)]">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">AI Tutor</h1>
        <button onclick="showNewConversation()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">New Conversation</button>
    </div>

    <div class="flex flex-1 gap-4 min-h-0">
        <!-- Conversation History Sidebar -->
        <div class="hidden md:block w-56 flex-shrink-0 bg-white dark:bg-slate-800 rounded-xl p-3 overflow-y-auto">
            <h3 class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase mb-2">History</h3>
            <div id="conv-history" aria-live="polite" class="space-y-1"></div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden">
            <!-- Setup Banner (shows when no active conversation) -->
            <div id="tutor-setup" class="flex-1 flex flex-col items-center justify-center p-8 space-y-4">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-indigo-600 dark:text-indigo-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                </div>
                <h2 class="text-xl font-bold">Start a Tutoring Session</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 text-center max-w-md">Choose a subject and topic. Your AI tutor uses the Socratic method to guide you through concepts, adapting to your level.</p>
                <div class="flex gap-2 flex-wrap justify-center items-start">
                    <!-- Subject: dropdown if enrolled subjects exist, otherwise free text -->
                    {% if profile and profile.subjects %}
                    <div class="w-48">
                        <select id="tutor-subject-select" onchange="handleTutorSubjectChange(this)"
                                class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm">
                            <option value="">Select subject...</option>
                            {% for s in profile.subjects %}
                            <option value="{{ s.name }}">{{ s.name }} ({{ s.level }})</option>
                            {% endfor %}
                            <option value="__custom__">Other...</option>
                        </select>
                        <input id="tutor-subject" placeholder="Type subject..." class="hidden w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm mt-1">
                    </div>
                    {% else %}
                    <div class="w-48">
                        <input id="tutor-subject" placeholder="Subject" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm">
                    </div>
                    {% endif %}

                    <!-- Topic: dropdown populated from syllabus topics, with free text fallback -->
                    <div class="w-48">
                        <select id="tutor-topic-select" onchange="handleTutorTopicChange(this)"
                                class="hidden w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm">
                            <option value="">Select topic...</option>
                        </select>
                        <input id="tutor-topic" placeholder="Topic (optional)" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 text-sm">
                    </div>

                    <button onclick="startConversation()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">Start</button>
                </div>

                {% if profile and profile.subjects %}
                <div class="pt-4">
                    <p class="text-xs text-slate-400 mb-2">Quick start:</p>
                    <div class="flex gap-2 flex-wrap justify-center">
                        {% for s in profile.subjects[:3] %}
                        <button onclick="quickStart('{{ s.name }}','')" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full text-xs hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-300">{{ s.name }}</button>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="pt-4">
                    <p class="text-xs text-slate-400 mb-2">Suggested prompts:</p>
                    <div class="flex gap-2 flex-wrap justify-center">
                        <button onclick="quickStart('Biology','Photosynthesis')" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full text-xs hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-300">Biology: Photosynthesis</button>
                        <button onclick="quickStart('Chemistry','Bonding')" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full text-xs hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-300">Chemistry: Bonding</button>
                        <button onclick="quickStart('Economics','Market Failure')" class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full text-xs hover:bg-slate-200 dark:hover:bg-slate-600 dark:text-slate-300">Economics: Market Failure</button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Messages -->
            <div id="tutor-messages" class="hidden flex-1 overflow-y-auto p-4 space-y-4" aria-live="polite"></div>

            <!-- Input -->
            <div id="tutor-input" class="hidden border-t border-slate-200 dark:border-slate-700 p-3 flex gap-2">
                <button onclick="document.getElementById('tutor-image-input').click()" type="button"
                        aria-label="Upload image"
                        class="p-2 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:text-indigo-600 hover:border-indigo-400 transition-colors flex-shrink-0 min-w-[44px] min-h-[44px] flex items-center justify-center">
                    <svg class="w-5 h-5" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                    </svg>
                </button>
                <input type="file" id="tutor-image-input" class="hidden" accept="image/*" onchange="uploadTutorImage(this)">
                <input id="tutor-message" placeholder="Ask your tutor..." class="flex-1 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200" onkeydown="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">Send</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Embedded syllabus topics for instant dropdown population
    window.TUTOR_SYLLABUS_TOPICS = {{ syllabus_topics | tojson }};

    function handleTutorSubjectChange(selectEl) {
        const subjectInput = document.getElementById('tutor-subject');
        const topicSelect = document.getElementById('tutor-topic-select');
        const topicInput = document.getElementById('tutor-topic');

        if (selectEl.value === '__custom__') {
            // Show free text for subject, hide topic dropdown
            subjectInput.classList.remove('hidden');
            subjectInput.value = '';
            subjectInput.focus();
            topicSelect.classList.add('hidden');
            topicInput.classList.remove('hidden');
            topicInput.value = '';
            return;
        }

        // Hide free text subject input
        subjectInput.classList.add('hidden');
        subjectInput.value = selectEl.value;

        // Populate topic dropdown from embedded data
        const topics = window.TUTOR_SYLLABUS_TOPICS[selectEl.value] || [];
        if (topics.length > 0) {
            topicSelect.innerHTML = '<option value="">Select topic...</option>';
            topics.forEach(function(t) {
                var opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.hl_only ? t.name + ' (HL)' : t.name;
                topicSelect.appendChild(opt);
            });
            var freeOpt = document.createElement('option');
            freeOpt.value = '__custom__';
            freeOpt.textContent = 'Other (type your own)...';
            topicSelect.appendChild(freeOpt);
            topicSelect.classList.remove('hidden');
            topicInput.classList.add('hidden');
            topicInput.value = '';
        } else {
            topicSelect.classList.add('hidden');
            topicInput.classList.remove('hidden');
            topicInput.value = '';
        }
    }

    function handleTutorTopicChange(selectEl) {
        var topicInput = document.getElementById('tutor-topic');
        if (selectEl.value === '__custom__') {
            selectEl.classList.add('hidden');
            topicInput.classList.remove('hidden');
            topicInput.value = '';
            topicInput.focus();
        } else {
            topicInput.value = selectEl.value;
        }
    }
</script>
<script type="module" src="{{ url_for('static', filename='js/modules/tutor.js') }}"></script>
{% endblock %}
