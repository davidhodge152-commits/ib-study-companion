{% extends "base.html" %}
{% block title %}Insights â€” IB Study Companion{% endblock %}

{% block content %}
<div class="mb-8 flex items-start justify-between">
    <div>
        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Insights</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Data-driven analysis of your IB preparation.</p>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('export.api_export_report') }}" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            PDF Report
        </a>
        <a href="{{ url_for('export.api_export_grades') }}" class="px-4 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 text-sm font-medium rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            Export CSV
        </a>
    </div>
</div>

<!-- Top 3 Insights -->
<div id="insights-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" aria-live="polite">
    <!-- Skeleton loading -->
    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5" role="status">
        <span class="sr-only">Loading insights...</span>
        <div class="skeleton rounded h-4 w-1/3 mb-4"></div>
        <div class="space-y-3">
            <div class="skeleton rounded h-4 w-full"></div>
            <div class="skeleton rounded h-4 w-2/3"></div>
        </div>
    </div>
    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5" role="status">
        <span class="sr-only">Loading...</span>
        <div class="skeleton rounded h-4 w-1/3 mb-4"></div>
        <div class="space-y-3">
            <div class="skeleton rounded h-4 w-full"></div>
            <div class="skeleton rounded h-4 w-2/3"></div>
        </div>
    </div>
    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5" role="status">
        <span class="sr-only">Loading...</span>
        <div class="skeleton rounded h-4 w-1/3 mb-4"></div>
        <div class="space-y-3">
            <div class="skeleton rounded h-4 w-full"></div>
            <div class="skeleton rounded h-4 w-2/3"></div>
        </div>
    </div>
</div>

<!-- Command Term Breakdown -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="ct-breakdown-section">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Command Term Breakdown</h3>
    <div id="ct-breakdown-content">
        <div class="skeleton rounded h-4 w-full mb-2"></div><div class="skeleton rounded h-4 w-3/4"></div>
    </div>
</div>

<!-- Subject Gap Table -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden mb-8" id="gap-table-section">
    <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Subject Gaps</h3>
    </div>
    <div id="gap-table-content">
        <div class="skeleton rounded h-4 w-full mb-2"></div><div class="skeleton rounded h-4 w-3/4"></div>
    </div>
</div>

<!-- Study Allocation -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="allocation-section">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Suggested Study Allocation</h3>
    <div id="allocation-content">
        <div class="skeleton rounded h-4 w-full mb-2"></div><div class="skeleton rounded h-4 w-3/4"></div>
    </div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Grade Trend</h3>
        <canvas id="trend-chart" height="200" role="img" aria-label="Grade trend chart"></canvas>
        <div class="sr-only" id="trend-chart-desc"></div>
        <p id="trend-empty" class="hidden text-sm text-slate-400 text-center py-10">No grading data yet.</p>
    </div>
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Grade Distribution</h3>
        <canvas id="dist-chart" height="200" role="img" aria-label="Grade distribution chart"></canvas>
        <div class="sr-only" id="dist-chart-desc"></div>
        <p id="dist-empty" class="hidden text-sm text-slate-400 text-center py-10">No grading data yet.</p>
    </div>
</div>

<!-- Syllabus Coverage Heatmap -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="coverage-section" style="display:none;">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Syllabus Coverage</h3>
    <div id="coverage-content" class="space-y-4"></div>
</div>

<!-- Misconception Tracker -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="misconception-section" style="display:none;">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Misconception Tracker</h3>
    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">Recurring patterns detected from your graded answers. Active misconceptions auto-generate targeted flashcards.</p>
    <div id="misconception-content" class="space-y-3"></div>
</div>

<!-- Predicted Grade Confidence -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="predicted-grade-section" style="display:none;">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Predicted Grade Confidence</h3>
    <div id="predicted-grade-content" class="space-y-4"></div>
</div>

<!-- Mock Exam Reports -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8" id="mock-reports-section" style="display:none;">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Mock Exam Reports</h3>
    <div id="mock-reports-content" class="space-y-4"></div>
</div>

<!-- Weakness Report -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">AI Weakness Report</h3>
        <button onclick="generateWeaknessReport()"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded-lg transition-colors"
                id="weakness-btn">
            Generate Report
        </button>
    </div>
    <div id="weakness-content">
        <p class="text-sm text-slate-400">Click "Generate Report" to analyze your recurring weaknesses.</p>
    </div>
</div>

<!-- Writing Profile -->
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6" id="writing-section" style="display:none;">
    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">Your Writing Style Profile</h3>
    <div id="writing-content" class="space-y-3 text-sm text-slate-600 dark:text-slate-300"></div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { loadInsights } from '/static/js/modules/insights.js';
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadInsights);
    } else {
        loadInsights();
    }
</script>
{% endblock %}
